#include <gtest/gtest.h>

#include "action/close.h"
#include "action/update.h"
#include "golden_test.h"
#include "module.h"

TEST(GoldenTest, RippleShader) {
    Modules modules;
    const auto* file = "ripple_shader.sksl";
    auto content = ReadSkSL(__FILE__);
    auto kind = GetSkSLProgramKind(content);
    auto update_result = Update(&modules, {.file = file, .content = content, .kind = kind});
    EXPECT_TRUE(update_result.succeed);
    // NOLINTBEGIN
    ExpectTokens(
        modules.find(file)->second,
        {
            {{198, 202},   true,  "vec2"                    },
            {{203, 212},   false, "in_origin"               },
            {{222, 226},   true,  "vec2"                    },
            {{227, 235},   false, "in_touch"                },
            {{245, 250},   true,  "float"                   },
            {{251, 262},   false, "in_progress"             },
            {{272, 277},   true,  "float"                   },
            {{278, 290},   false, "in_maxRadius"            },
            {{300, 304},   true,  "vec2"                    },
            {{305, 323},   false, "in_resolutionScale"      },
            {{333, 337},   true,  "vec2"                    },
            {{338, 351},   false, "in_noiseScale"           },
            {{361, 366},   true,  "float"                   },
            {{367, 377},   false, "in_hasMask"              },
            {{387, 392},   true,  "float"                   },
            {{393, 406},   false, "in_noisePhase"           },
            {{416, 421},   true,  "float"                   },
            {{422, 440},   false, "in_turbulencePhase"      },
            {{450, 454},   true,  "vec2"                    },
            {{455, 466},   false, "in_tCircle1"             },
            {{476, 480},   true,  "vec2"                    },
            {{481, 492},   false, "in_tCircle2"             },
            {{502, 506},   true,  "vec2"                    },
            {{507, 518},   false, "in_tCircle3"             },
            {{528, 532},   true,  "vec2"                    },
            {{533, 546},   false, "in_tRotation1"           },
            {{556, 560},   true,  "vec2"                    },
            {{561, 574},   false, "in_tRotation2"           },
            {{584, 588},   true,  "vec2"                    },
            {{589, 602},   false, "in_tRotation3"           },
            {{626, 630},   true,  "vec4"                    },
            {{631, 639},   false, "in_color"                },
            {{663, 667},   true,  "vec4"                    },
            {{668, 683},   false, "in_sparkleColor"         },
            {{693, 699},   true,  "shader"                  },
            {{700, 709},   false, "in_shader"               },
            {{718, 731},   false, "triangleNoise"           },
            {{737, 738},   false, "n"                       },
            {{746, 747},   true,  "n"                       },
            {{750, 755},   true,  "fract"                   },
            {{756, 757},   true,  "n"                       },
            {{760, 764},   true,  "vec2"                    },
            {{765, 771},   false, "5.3987"                  },
            {{773, 779},   false, "5.4421"                  },
            {{787, 788},   true,  "n"                       },
            {{792, 795},   true,  "dot"                     },
            {{796, 797},   true,  "n"                       },
            {{798, 800},   true,  "yx"                      },
            {{802, 803},   true,  "n"                       },
            {{809, 813},   true,  "vec2"                    },
            {{814, 821},   false, "21.5351"                 },
            {{823, 830},   false, "14.3137"                 },
            {{838, 843},   true,  "float"                   },
            {{844, 846},   false, "xy"                      },
            {{849, 850},   true,  "n"                       },
            {{851, 852},   true,  "x"                       },
            {{855, 856},   true,  "n"                       },
            {{857, 858},   true,  "y"                       },
            {{871, 876},   true,  "fract"                   },
            {{877, 879},   true,  "xy"                      },
            {{882, 889},   false, "95.4307"                 },
            {{893, 898},   true,  "fract"                   },
            {{899, 901},   true,  "xy"                      },
            {{904, 912},   false, "75.04961"                },
            {{916, 919},   false, "1.0"                     },
            {{929, 934},   true,  "float"                   },
            {{935, 937},   false, "PI"                      },
            {{940, 964},   false, "3.1415926535897932384626"},
            {{972, 981},   false, "threshold"               },
            {{988, 989},   false, "v"                       },
            {{997, 998},   false, "l"                       },
            {{1006, 1007}, false, "h"                       },
            {{1022, 1026}, true,  "step"                    },
            {{1027, 1028}, true,  "l"                       },
            {{1030, 1031}, true,  "v"                       },
            {{1036, 1039}, false, "1.0"                     },
            {{1042, 1046}, true,  "step"                    },
            {{1047, 1048}, true,  "h"                       },
            {{1050, 1051}, true,  "v"                       },
            {{1063, 1071}, false, "sparkles"                },
            {{1077, 1079}, false, "uv"                      },
            {{1087, 1088}, false, "t"                       },
            {{1096, 1101}, true,  "float"                   },
            {{1102, 1103}, false, "n"                       },
            {{1106, 1119}, true,  "triangleNoise"           },
            {{1120, 1122}, true,  "uv"                      },
            {{1129, 1134}, true,  "float"                   },
            {{1135, 1136}, false, "s"                       },
            {{1139, 1142}, false, "0.0"                     },
            {{1153, 1158}, true,  "float"                   },
            {{1159, 1160}, false, "i"                       },
            {{1163, 1164}, false, "0"                       },
            {{1170, 1171}, true,  "i"                       },
            {{1174, 1175}, false, "4"                       },
            {{1181, 1182}, true,  "i"                       },
            {{1186, 1187}, false, "1"                       },
            {{1199, 1204}, true,  "float"                   },
            {{1205, 1206}, false, "l"                       },
            {{1209, 1210}, true,  "i"                       },
            {{1213, 1216}, false, "0.1"                     },
            {{1226, 1231}, true,  "float"                   },
            {{1232, 1233}, false, "h"                       },
            {{1236, 1237}, true,  "l"                       },
            {{1240, 1244}, false, "0.05"                    },
            {{1254, 1259}, true,  "float"                   },
            {{1260, 1261}, false, "o"                       },
            {{1264, 1267}, true,  "sin"                     },
            {{1268, 1270}, true,  "PI"                      },
            {{1274, 1275}, true,  "t"                       },
            {{1278, 1282}, false, "0.35"                    },
            {{1285, 1286}, true,  "i"                       },
            {{1298, 1299}, true,  "s"                       },
            {{1303, 1312}, true,  "threshold"               },
            {{1313, 1314}, true,  "n"                       },
            {{1317, 1318}, true,  "o"                       },
            {{1320, 1321}, true,  "l"                       },
            {{1323, 1324}, true,  "h"                       },
            {{1344, 1352}, true,  "saturate"                },
            {{1353, 1354}, true,  "s"                       },
            {{1358, 1373}, true,  "in_sparkleColor"         },
            {{1385, 1395}, false, "softCircle"              },
            {{1401, 1403}, false, "uv"                      },
            {{1410, 1412}, false, "xy"                      },
            {{1420, 1426}, false, "radius"                  },
            {{1434, 1438}, false, "blur"                    },
            {{1446, 1451}, true,  "float"                   },
            {{1452, 1460}, false, "blurHalf"                },
            {{1463, 1467}, true,  "blur"                    },
            {{1470, 1473}, false, "0.5"                     },
            {{1479, 1484}, true,  "float"                   },
            {{1485, 1486}, false, "d"                       },
            {{1489, 1497}, true,  "distance"                },
            {{1498, 1500}, true,  "uv"                      },
            {{1502, 1504}, true,  "xy"                      },
            {{1518, 1520}, false, "1."                      },
            {{1523, 1533}, true,  "smoothstep"              },
            {{1534, 1536}, false, "1."                      },
            {{1539, 1547}, true,  "blurHalf"                },
            {{1549, 1551}, false, "1."                      },
            {{1554, 1562}, true,  "blurHalf"                },
            {{1564, 1565}, true,  "d"                       },
            {{1568, 1574}, true,  "radius"                  },
            {{1585, 1593}, false, "softRing"                },
            {{1599, 1601}, false, "uv"                      },
            {{1608, 1610}, false, "xy"                      },
            {{1618, 1624}, false, "radius"                  },
            {{1632, 1640}, false, "progress"                },
            {{1648, 1652}, false, "blur"                    },
            {{1660, 1665}, true,  "float"                   },
            {{1666, 1675}, false, "thickness"               },
            {{1678, 1682}, false, "0.05"                    },
            {{1685, 1691}, true,  "radius"                  },
            {{1697, 1702}, true,  "float"                   },
            {{1703, 1716}, false, "currentRadius"           },
            {{1719, 1725}, true,  "radius"                  },
            {{1728, 1736}, true,  "progress"                },
            {{1742, 1747}, true,  "float"                   },
            {{1748, 1760}, false, "circle_outer"            },
            {{1763, 1773}, true,  "softCircle"              },
            {{1774, 1776}, true,  "uv"                      },
            {{1778, 1780}, true,  "xy"                      },
            {{1782, 1795}, true,  "currentRadius"           },
            {{1798, 1807}, true,  "thickness"               },
            {{1809, 1813}, true,  "blur"                    },
            {{1820, 1825}, true,  "float"                   },
            {{1826, 1838}, false, "circle_inner"            },
            {{1841, 1851}, true,  "softCircle"              },
            {{1852, 1854}, true,  "uv"                      },
            {{1856, 1858}, true,  "xy"                      },
            {{1860, 1863}, true,  "max"                     },
            {{1864, 1877}, true,  "currentRadius"           },
            {{1880, 1889}, true,  "thickness"               },
            {{1891, 1893}, false, "0."                      },
            {{1896, 1900}, true,  "blur"                    },
            {{1914, 1922}, true,  "saturate"                },
            {{1923, 1935}, true,  "circle_outer"            },
            {{1938, 1950}, true,  "circle_inner"            },
            {{1961, 1972}, false, "subProgress"             },
            {{1979, 1984}, false, "start"                   },
            {{1992, 1995}, false, "end"                     },
            {{2003, 2011}, false, "progress"                },
            {{2019, 2024}, true,  "float"                   },
            {{2025, 2028}, false, "sub"                     },
            {{2031, 2036}, true,  "clamp"                   },
            {{2037, 2045}, true,  "progress"                },
            {{2047, 2052}, true,  "start"                   },
            {{2054, 2057}, true,  "end"                     },
            {{2072, 2075}, true,  "sub"                     },
            {{2078, 2083}, true,  "start"                   },
            {{2088, 2091}, true,  "end"                     },
            {{2094, 2099}, true,  "start"                   },
            {{2109, 2117}, false, "rotate2d"                },
            {{2123, 2126}, false, "rad"                     },
            {{2141, 2145}, true,  "mat2"                    },
            {{2146, 2149}, true,  "rad"                     },
            {{2150, 2151}, true,  "x"                       },
            {{2154, 2157}, true,  "rad"                     },
            {{2158, 2159}, true,  "y"                       },
            {{2161, 2164}, true,  "rad"                     },
            {{2165, 2166}, true,  "y"                       },
            {{2168, 2171}, true,  "rad"                     },
            {{2172, 2173}, true,  "x"                       },
            {{2184, 2195}, false, "circle_grid"             },
            {{2201, 2211}, false, "resolution"              },
            {{2218, 2223}, false, "coord"                   },
            {{2231, 2235}, false, "time"                    },
            {{2242, 2248}, false, "center"                  },
            {{2255, 2263}, false, "rotation"                },
            {{2271, 2284}, false, "cell_diameter"           },
            {{2292, 2297}, true,  "coord"                   },
            {{2300, 2308}, true,  "rotate2d"                },
            {{2309, 2317}, true,  "rotation"                },
            {{2322, 2328}, true,  "center"                  },
            {{2331, 2336}, true,  "coord"                   },
            {{2340, 2346}, true,  "center"                  },
            {{2352, 2357}, true,  "coord"                   },
            {{2360, 2363}, true,  "mod"                     },
            {{2364, 2369}, true,  "coord"                   },
            {{2371, 2384}, true,  "cell_diameter"           },
            {{2388, 2398}, true,  "resolution"              },
            {{2404, 2409}, true,  "float"                   },
            {{2410, 2423}, false, "normal_radius"           },
            {{2426, 2439}, true,  "cell_diameter"           },
            {{2442, 2452}, true,  "resolution"              },
            {{2453, 2454}, true,  "y"                       },
            {{2457, 2460}, false, "0.5"                     },
            {{2466, 2471}, true,  "float"                   },
            {{2472, 2478}, false, "radius"                  },
            {{2481, 2485}, false, "0.65"                    },
            {{2488, 2501}, true,  "normal_radius"           },
            {{2514, 2524}, true,  "softCircle"              },
            {{2525, 2530}, true,  "coord"                   },
            {{2532, 2536}, true,  "vec2"                    },
            {{2537, 2550}, true,  "normal_radius"           },
            {{2553, 2559}, true,  "radius"                  },
            {{2561, 2567}, true,  "radius"                  },
            {{2570, 2574}, false, "50.0"                    },
            {{2585, 2595}, false, "turbulence"              },
            {{2601, 2603}, false, "uv"                      },
            {{2611, 2612}, false, "t"                       },
            {{2626, 2630}, true,  "vec2"                    },
            {{2631, 2636}, false, "scale"                   },
            {{2639, 2643}, true,  "vec2"                    },
            {{2644, 2647}, false, "0.8"                     },
            {{2654, 2656}, true,  "uv"                      },
            {{2659, 2661}, true,  "uv"                      },
            {{2664, 2669}, true,  "scale"                   },
            {{2675, 2680}, true,  "float"                   },
            {{2681, 2683}, false, "g1"                      },
            {{2686, 2697}, true,  "circle_grid"             },
            {{2698, 2703}, true,  "scale"                   },
            {{2705, 2707}, true,  "uv"                      },
            {{2709, 2710}, true,  "t"                       },
            {{2712, 2723}, true,  "in_tCircle1"             },
            {{2725, 2738}, true,  "in_tRotation1"           },
            {{2740, 2744}, false, "0.17"                    },
            {{2751, 2756}, true,  "float"                   },
            {{2757, 2759}, false, "g2"                      },
            {{2762, 2773}, true,  "circle_grid"             },
            {{2774, 2779}, true,  "scale"                   },
            {{2781, 2783}, true,  "uv"                      },
            {{2785, 2786}, true,  "t"                       },
            {{2788, 2799}, true,  "in_tCircle2"             },
            {{2801, 2814}, true,  "in_tRotation2"           },
            {{2816, 2819}, false, "0.2"                     },
            {{2826, 2831}, true,  "float"                   },
            {{2832, 2834}, false, "g3"                      },
            {{2837, 2848}, true,  "circle_grid"             },
            {{2849, 2854}, true,  "scale"                   },
            {{2856, 2858}, true,  "uv"                      },
            {{2860, 2861}, true,  "t"                       },
            {{2863, 2874}, true,  "in_tCircle3"             },
            {{2876, 2889}, true,  "in_tRotation3"           },
            {{2891, 2896}, false, "0.275"                   },
            {{2903, 2908}, true,  "float"                   },
            {{2909, 2910}, false, "v"                       },
            {{2914, 2916}, true,  "g1"                      },
            {{2919, 2921}, true,  "g1"                      },
            {{2924, 2926}, true,  "g2"                      },
            {{2929, 2931}, true,  "g3"                      },
            {{2935, 2938}, false, "0.5"                     },
            {{2951, 2959}, true,  "saturate"                },
            {{2960, 2964}, false, "0.45"                    },
            {{2967, 2970}, false, "0.8"                     },
            {{2973, 2974}, true,  "v"                       },
            {{2985, 2989}, false, "main"                    },
            {{2995, 2996}, false, "p"                       },
            {{3004, 3009}, true,  "float"                   },
            {{3010, 3016}, false, "fadeIn"                  },
            {{3019, 3030}, true,  "subProgress"             },
            {{3031, 3033}, false, "0."                      },
            {{3035, 3039}, false, "0.13"                    },
            {{3041, 3052}, true,  "in_progress"             },
            {{3059, 3064}, true,  "float"                   },
            {{3065, 3072}, false, "scaleIn"                 },
            {{3075, 3086}, true,  "subProgress"             },
            {{3087, 3089}, false, "0."                      },
            {{3091, 3094}, false, "1.0"                     },
            {{3096, 3107}, true,  "in_progress"             },
            {{3114, 3119}, true,  "float"                   },
            {{3120, 3132}, false, "fadeOutNoise"            },
            {{3135, 3146}, true,  "subProgress"             },
            {{3147, 3150}, false, "0.4"                     },
            {{3152, 3155}, false, "0.5"                     },
            {{3157, 3168}, true,  "in_progress"             },
            {{3175, 3180}, true,  "float"                   },
            {{3181, 3194}, false, "fadeOutRipple"           },
            {{3197, 3208}, true,  "subProgress"             },
            {{3209, 3212}, false, "0.4"                     },
            {{3214, 3216}, false, "1."                      },
            {{3218, 3229}, true,  "in_progress"             },
            {{3236, 3240}, true,  "vec2"                    },
            {{3241, 3247}, false, "center"                  },
            {{3250, 3253}, true,  "mix"                     },
            {{3254, 3262}, true,  "in_touch"                },
            {{3264, 3273}, true,  "in_origin"               },
            {{3275, 3283}, true,  "saturate"                },
            {{3284, 3295}, true,  "in_progress"             },
            {{3298, 3301}, false, "2.0"                     },
            {{3309, 3314}, true,  "float"                   },
            {{3315, 3319}, false, "ring"                    },
            {{3322, 3330}, true,  "softRing"                },
            {{3331, 3332}, true,  "p"                       },
            {{3334, 3340}, true,  "center"                  },
            {{3342, 3354}, true,  "in_maxRadius"            },
            {{3356, 3363}, true,  "scaleIn"                 },
            {{3365, 3367}, false, "1."                      },
            {{3374, 3379}, true,  "float"                   },
            {{3380, 3385}, false, "alpha"                   },
            {{3388, 3391}, true,  "min"                     },
            {{3392, 3398}, true,  "fadeIn"                  },
            {{3400, 3402}, false, "1."                      },
            {{3405, 3417}, true,  "fadeOutNoise"            },
            {{3424, 3428}, true,  "vec2"                    },
            {{3429, 3431}, false, "uv"                      },
            {{3434, 3435}, true,  "p"                       },
            {{3438, 3456}, true,  "in_resolutionScale"      },
            {{3462, 3466}, true,  "vec2"                    },
            {{3467, 3476}, false, "densityUv"               },
            {{3479, 3481}, true,  "uv"                      },
            {{3484, 3487}, true,  "mod"                     },
            {{3488, 3490}, true,  "uv"                      },
            {{3492, 3505}, true,  "in_noiseScale"           },
            {{3512, 3517}, true,  "float"                   },
            {{3518, 3528}, false, "turbulence"              },
            {{3531, 3541}, true,  "turbulence"              },
            {{3542, 3544}, true,  "uv"                      },
            {{3546, 3564}, true,  "in_turbulencePhase"      },
            {{3571, 3576}, true,  "float"                   },
            {{3577, 3589}, false, "sparkleAlpha"            },
            {{3592, 3600}, true,  "sparkles"                },
            {{3601, 3610}, true,  "densityUv"               },
            {{3612, 3625}, true,  "in_noisePhase"           },
            {{3629, 3633}, true,  "ring"                    },
            {{3636, 3641}, true,  "alpha"                   },
            {{3644, 3654}, true,  "turbulence"              },
            {{3660, 3665}, true,  "float"                   },
            {{3666, 3670}, false, "fade"                    },
            {{3673, 3676}, true,  "min"                     },
            {{3677, 3683}, true,  "fadeIn"                  },
            {{3685, 3687}, false, "1."                      },
            {{3690, 3703}, true,  "fadeOutRipple"           },
            {{3710, 3715}, true,  "float"                   },
            {{3716, 3725}, false, "waveAlpha"               },
            {{3728, 3738}, true,  "softCircle"              },
            {{3739, 3740}, true,  "p"                       },
            {{3742, 3748}, true,  "center"                  },
            {{3750, 3762}, true,  "in_maxRadius"            },
            {{3765, 3772}, true,  "scaleIn"                 },
            {{3774, 3776}, false, "1."                      },
            {{3780, 3784}, true,  "fade"                    },
            {{3787, 3795}, true,  "in_color"                },
            {{3803, 3807}, true,  "vec4"                    },
            {{3808, 3817}, false, "waveColor"               },
            {{3820, 3824}, true,  "vec4"                    },
            {{3825, 3833}, true,  "in_color"                },
            {{3840, 3849}, true,  "waveAlpha"               },
            {{3867, 3871}, true,  "vec4"                    },
            {{3872, 3884}, false, "sparkleColor"            },
            {{3887, 3891}, true,  "vec4"                    },
            {{3892, 3907}, true,  "in_sparkleColor"         },
            {{3914, 3929}, true,  "in_sparkleColor"         },
            {{3933, 3948}, true,  "in_sparkleColor"         },
            {{3957, 3962}, true,  "float"                   },
            {{3963, 3967}, false, "mask"                    },
            {{3970, 3980}, true,  "in_hasMask"              },
            {{3984, 3986}, false, "1."                      },
            {{3989, 3998}, true,  "in_shader"               },
            {{3999, 4003}, true,  "eval"                    },
            {{4004, 4005}, true,  "p"                       },
            {{4011, 4013}, false, "0."                      },
            {{4016, 4018}, false, "1."                      },
            {{4021, 4023}, false, "0."                      },
            {{4026, 4028}, false, "1."                      },
            {{4041, 4044}, true,  "mix"                     },
            {{4045, 4054}, true,  "waveColor"               },
            {{4056, 4068}, true,  "sparkleColor"            },
            {{4070, 4082}, true,  "sparkleAlpha"            },
            {{4086, 4090}, true,  "mask"                    },
    }
    );
    // NOLINTEND
    auto close_result = Close(&modules, {.file = file});
    EXPECT_TRUE(close_result.succeed);
}
